<html>

<body>
    <section id="movie">
    </section>

    <script>
        getMovieIdFromHash = () => {
            const hash = location.hash;
            const match = hash.match(/id=([^&]+)/);
            return match ? decodeURIComponent(match[1]) : null;
        }

        (async ($, $ff, sections) => {
            const movie = sections('movie');

            return async (query) => {
                let layout = await $ff('comp/layout.html');
                layout.face(movie());
                layout.header($());

                let face = layout.getFace();
                let header = layout.getHeader();

                let movieId = getMovieIdFromHash();

                if (!movieId) {
                    location.hash = 'home';
                    return;
                }

                let movies = await cmclient.getMovies();
                let selected = movies.find(m => m.movieId === movieId);

                if (!selected) {
                    location.hash = 'home';
                    return;
                }

                let sessionId = localStorage.getItem('sessionId');
                let sessionPlaceholder = header.find('.session-id')

                if (!sessionPlaceholder.length) {
                    sessionPlaceholder = $('<span class="session-id"></span>');
                    sessionPlaceholder.text(`Sess√£o: ${sessionId || 'Nenhuma'}`);
                    header.append(sessionPlaceholder);
                }

                // Hero Section com backdrop
                face.append(`
                    <div class="movie-hero">
                        <div class="hero-backdrop" style="background-image: url('${selected.poster}')"></div>
                        <div class="hero-overlay"></div>
                        <div class="hero-content">
                            <div class="movie-poster-container">
                                <img src="${selected.poster}" alt="${selected.title}" class="movie-poster">
                                <div class="rating-badge">
                                    <span class="rating-star">‚òÖ</span>
                                    <span class="rating-value">${selected.imdb_rating}</span>
                                </div>
                            </div>
                            <div class="movie-main-info">
                                <h1 class="movie-title">${selected.title}</h1>
                                <div class="movie-meta">
                                    <span class="release-year">${selected.released.split(' ').pop()}</span>
                                    <span class="runtime">‚è±Ô∏è ${selected.runtime}</span>
                                    <span class="language">üåç ${selected.language}</span>
                                </div>
                                <div class="genre-tags">
                                    ${selected.genres.map(genre => `<span class="genre-tag">${genre}</span>`).join('')}
                                </div>
                                <p class="movie-plot">${selected.plot}</p>
                            </div>
                        </div>
                    </div>
                `);

                // Movie Details Section
                face.append(`
                    <div class="movie-details">
                        <div class="details-grid">
                            <div class="detail-card cast-card">
                                <h3>üé≠ Elenco Principal</h3>
                                <p>${selected.actors}</p>
                            </div>
                            <div class="detail-card crew-card">
                                <h3>üé¨ Equipe</h3>
                                <div class="crew-info">
                                    <p><strong>Diretor:</strong> ${selected.director}</p>
                                    <p><strong>Roteirista:</strong> ${selected.writer}</p>
                                </div>
                            </div>
                            <div class="detail-card production-card">
                                <h3>üè≠ Produ√ß√£o</h3>
                                <div class="production-info">
                                    <p><strong>Pa√≠s:</strong> ${selected.country}</p>
                                    <p><strong>Lan√ßamento:</strong> ${selected.released}</p>
                                </div>
                            </div>
                            <div class="detail-card awards-card">
                                <h3>üèÜ Reconhecimentos</h3>
                                <p>${selected.awards}</p>
                            </div>
                        </div>
                    </div>
                `);

                const recs = await cmclient.getSessionRecommendation(sessionId, movieId);
                const recommendedMovies = recs.items
                    .map(rec => movies.find(m => m.movieId === rec.item_id))
                    .filter(Boolean); 

                if (recommendedMovies.length > 0) {
                    const recSection = $('<section class="recommendations-section"></section>');
                    recSection.append(`
                        <div class="recommendations-header">
                            <h2>‚ú® Descobertas Personalizadas</h2>
                            <p>Sele√ß√µes especiais baseadas no seu gosto</p>
                        </div>
                    `);

                    const recGrid = $('<div class="recommendations-grid"></div>');

                    for (let movie of recommendedMovies) {
                        const card = $(`
                            <article class="recommendation-card">
                                <a href="#movie?id=${movie.movieId}">
                                    <div class="card-image-container">
                                        <img src="${movie.poster}" alt="${movie.title}">
                                        <div class="card-overlay">
                                            <span class="play-icon">‚ñ∂</span>
                                        </div>
                                    </div>
                                    <div class="card-content">
                                        <h4>${movie.title}</h4>
                                        <p class="card-genres">${movie.genres ? movie.genres.slice(0, 2).join(', ') : ''}</p>
                                    </div>
                                </a>
                            </article>
                        `);
                        card.find('a').on('click', () => {
                            cmclient.movieEventPost(sessionId, movie.movieId); 
                        });

                        recGrid.append(card);
                    }

                    recSection.append(recGrid);
                    face.append(recSection);
                }

                // Action buttons
                face.append(`
                    <div class="action-section">
                        <button class="action-btn home-btn">
                            üè† Explorar Mais Filmes
                        </button>
                    </div>
                `);

                face.find('.home-btn').on('click', () => {
                    location.hash = 'home';
                });
            };
        })
    </script>

</body>

</html>